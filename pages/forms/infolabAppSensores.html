<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>InfolabApp</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <!-- Bootstrap 3.3.7 -->
  <link rel="stylesheet" href="../../bower_components/bootstrap/dist/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="../../bower_components/font-awesome/css/font-awesome.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="../../bower_components/Ionicons/css/ionicons.min.css">
  <!-- daterange picker -->
  <link rel="stylesheet" href="../../bower_components/bootstrap-daterangepicker/daterangepicker.css">
  <!-- bootstrap datepicker -->
  <link rel="stylesheet" href="../../bower_components/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css">
  <!-- iCheck for checkboxes and radio inputs -->
  <link rel="stylesheet" href="../../plugins/iCheck/all.css">
  <!-- Bootstrap Color Picker -->
  <link rel="stylesheet" href="../../bower_components/bootstrap-colorpicker/dist/css/bootstrap-colorpicker.min.css">
  <!-- Bootstrap time Picker -->
  <link rel="stylesheet" href="../../plugins/timepicker/bootstrap-timepicker.min.css">
  <!-- Select2 -->
  <link rel="stylesheet" href="../../bower_components/select2/dist/css/select2.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../../dist/css/AdminLTE.min.css">
  <!-- AdminLTE Skins. Choose a skin from the css/skins
       folder instead of downloading all of them to reduce the load. -->
  <link rel="stylesheet" href="../../dist/css/skins/_all-skins.min.css">
  <script src="../../node_modules/echarts//dist/echarts.js"></script>

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->

  <!-- Google Font -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">
</head>

<body class="hold-transition skin-blue layout-top-nav">
  <div class="">

    <header class="main-header">
      <!-- Logo -->

      <!-- Header Navbar: style can be found in header.less -->
      <nav class="navbar navbar-static-top ">
        <div class="container-fluid">
          <div class="navbar-header">
            <a href="../../index2.html" class="navbar-brand"><b>InfoLab</b>App</a>
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
              <i class="fa fa-bars"></i>
            </button>
          </div>

          <!-- Collect the nav links, forms, and other content for toggling -->
          <div class="collapse navbar-collapse" id="navbar-collapse">
            <ul class="nav navbar-nav">
              <li class="active"><a href="#">Sensores <span class="sr-only">(current)</span></a></li>
              <li><a href="#">Actuadores</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li class="Usuario">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Usuario <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  <li><a href="#">Cerrar Sesi√≥n</a></li>
                </ul>
              </li>
            </ul>
          </div>
          <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
      </nav>
    </header>
    <!-- Content Wrapper. Contains page content -->
    <div class="">
      <!-- Main content -->
      <section class="content">
        <div class="row">
          <!-- /.col -->
          <div class="col-md-3">
            <div class="form-group">
              <select class="form-control select2" style="width: 100%;">
                <option selected="selected">Ruido</option>
                <option>Temperatura</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
          </div>
          <!-- /.col -->
          <div class="col-md-3 offset-md-4">
            <!-- Date and time range -->
            <div class="form-group">
              <div class="input-group">
                <div class="input-group-addon">
                  <i class="fa fa-clock-o"></i>
                </div>
                <input type="text" class="form-control pull-right" id="reservationtime">
              </div>
              <!-- /.input group -->
            </div>
            <!-- /.form group -->
          </div>
          <!-- /.col -->
        </div>
        <!-- /.row -->
        <div class="row">
          <div class="col-md-7">
            <svg width="400em" height="250em" style="margin-top: 7em; margin-left: 15em;">
              <rect onclick="probando(id)" id="infolabPasillo" width="400" height="90" y="80" style="fill:rgb(245, 205, 149);" />
              <rect onclick="probando(id)" id="redes" width="200" height="80" x="200" y="0" style="fill:rgb(245, 245, 149);" />
              <rect onclick="probando(id)" id="seguridad" width="130" height="80" x="270" y="170" style="fill:rgb(245, 149, 149);" />
              <rect onclick="probando(id)" id="computacionGrafica" width="130" height="80" x="140" y="170" style="fill:rgb(245, 245, 149);" />
              <rect onclick="probando(id)" id="infolabSalon" width="140" height="80" x="0" y="170" style="fill:rgb(245, 100, 100);" />
            </svg>
          </div>
          <div class="col-md-5">
            <div class="box box-default">
              <div class="box-header with-border">
                <h3 class="box-title">Grafica</h3>
              </div>
              <div class="box-body container">
                <div >
                    <div>
                        <div id="main" style="width:600px; height:350px;"></div>
                        <button onclick="cargarGraficaAreaSimple(0)">Hora</button>
                        <button onclick="cargarGraficaAreaSimple(1)">Dia</button>
                        <button onclick="cargarGraficaAreaSimple(2)">Mes</button>
                    </div>
                    <div>
                        <div id="main2" style="width:600px; height:350px;"></div>
                        <button onclick="cargarGraficaMapaDeCalor(0)">Dia</button>
                        <button onclick="cargarGraficaMapaDeCalor(1)">Mes</button>
                    </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->
    <footer class="main-footer">
      <div class="pull-right hidden-xs">
        <b>Version</b> 2.4.13
      </div>
      <strong>Copyright &copy; 2014-2019 <a href="https://adminlte.io">AdminLTE</a>.</strong> All rights
      reserved.
    </footer>

    <!-- jQuery 3 -->
    <script src="../../bower_components/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap 3.3.7 -->
    <script src="../../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- Select2 -->
    <script src="../../bower_components/select2/dist/js/select2.full.min.js"></script>
    <!-- InputMask -->
    <script src="../../plugins/input-mask/jquery.inputmask.js"></script>
    <script src="../../plugins/input-mask/jquery.inputmask.date.extensions.js"></script>
    <script src="../../plugins/input-mask/jquery.inputmask.extensions.js"></script>
    <!-- date-range-picker -->
    <script src="../../bower_components/moment/min/moment.min.js"></script>
    <script src="../../bower_components/bootstrap-daterangepicker/daterangepicker.js"></script>
    <!-- bootstrap datepicker -->
    <script src="../../bower_components/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>
    <!-- bootstrap color picker -->
    <script src="../../bower_components/bootstrap-colorpicker/dist/js/bootstrap-colorpicker.min.js"></script>
    <!-- bootstrap time picker -->
    <script src="../../plugins/timepicker/bootstrap-timepicker.min.js"></script>
    <!-- SlimScroll -->
    <script src="../../bower_components/jquery-slimscroll/jquery.slimscroll.min.js"></script>
    <!-- iCheck 1.0.1 -->
    <script src="../../plugins/iCheck/icheck.min.js"></script>
    <!-- FastClick -->
    <script src="../../bower_components/fastclick/lib/fastclick.js"></script>
    <!-- AdminLTE App -->
    <script src="../../dist/js/adminlte.min.js"></script>
    <!-- AdminLTE for demo purposes -->
    <script src="../../dist/js/demo.js"></script>
    <!-- Page script -->
    <script>
      function probando(id){
        alert(id);
      }
      $(function () {
        //Initialize Select2 Elements
        $('.select2').select2()

        //Datemask dd/mm/yyyy
        $('#datemask').inputmask('dd/mm/yyyy', { 'placeholder': 'dd/mm/yyyy' })
        //Datemask2 mm/dd/yyyy
        $('#datemask2').inputmask('mm/dd/yyyy', { 'placeholder': 'mm/dd/yyyy' })
        //Money Euro
        $('[data-mask]').inputmask()

        //Date range picker
        $('#reservation').daterangepicker()
        //Date range picker with time picker
        $('#reservationtime').daterangepicker({
          timePicker: true, applyButtonClasses: "btn-info", maxSpan:{days:7}, timePicker24Hour: true, timePickerIncrement: 60, autoApply: true, locale: {
            format: 'DD/MM/YYYY hh:mm A', applyLabel: "Aplicar", cancelLabel: "Cancelar", "daysOfWeek": [
              "Do",
              "Lu",
              "Ma",
              "Mi",
              "Ju",
              "Vi",
              "Sa"
            ],
            "monthNames": [
              "Enero",
              "Febrero",
              "Marzo",
              "Abril",
              "Mayo",
              "Junio",
              "Julio",
              "Agosto",
              "Septiembre",
              "Octubre",
              "Noviembre",
              "Diciembre"
            ],
          }
        })
        //Event date range picker
        $('#reservationtime').on('apply.daterangepicker', function (ev, picker) {
          console.log(picker.startDate.format('YYYY-MM-DD hh:mm:ss'));
          console.log(picker.endDate.format('YYYY-MM-DD hh:mm:ss'));
          traerDatos(picker.startDate.format('YYYY-MM-DD hh:mm:ss')+"&fin="+picker.endDate.format('YYYY-MM-DD hh:mm:ss'));
        })

        //Date range as a button
        $('#daterange-btn').daterangepicker(
          {
            ranges: {
              'Today': [moment(), moment()],
              'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
              'Last 7 Days': [moment().subtract(6, 'days'), moment()],
              'Last 30 Days': [moment().subtract(29, 'days'), moment()],
              'This Month': [moment().startOf('month'), moment().endOf('month')],
              'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            },
            startDate: moment().subtract(29, 'days'),
            endDate: moment()
          },
          function (start, end) {
            $('#daterange-btn span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'))
          }
        )

        //Date picker
        $('#datepicker').datepicker({
          autoclose: true
        })

        //iCheck for checkbox and radio inputs
        $('input[type="checkbox"].minimal, input[type="radio"].minimal').iCheck({
          checkboxClass: 'icheckbox_minimal-blue',
          radioClass: 'iradio_minimal-blue'
        })
        //Red color scheme for iCheck
        $('input[type="checkbox"].minimal-red, input[type="radio"].minimal-red').iCheck({
          checkboxClass: 'icheckbox_minimal-red',
          radioClass: 'iradio_minimal-red'
        })
        //Flat red color scheme for iCheck
        $('input[type="checkbox"].flat-red, input[type="radio"].flat-red').iCheck({
          checkboxClass: 'icheckbox_flat-green',
          radioClass: 'iradio_flat-green'
        })

        //Colorpicker
        $('.my-colorpicker1').colorpicker()
        //color picker with addon
        $('.my-colorpicker2').colorpicker()

        //Timepicker
        $('.timepicker').timepicker({
          showInputs: false
        })
      });

      var myChart = echarts.init(document.getElementById('main'));
      var myChart2 = echarts.init(document.getElementById('main2'));
      // specify chart configuration item and data
      var fechas = [];
      var valores = [];

      var data = ""; dataX = ""; dataY = "";

      var dias = [];
      var semanas = [];
      var meses = [];
      var horas = [];
      var valores = [];
      var celdas = [];
      var celdasMeses = [];

      var dia = "";
      var mes = "";
      var hora = "";
      var diasPorTodosLosMeses = [];

      var datosPrueba = [];
      var fechaPrueba;
      var s1 = 0, me1 = 0, me2=1; h1 = 0, h2 = 0,d1 = 1, a=2019, mi1=0, s2 = 0, mi2=0;
      var valorPrueba = 0;
      id=0;
      
      var suma = 0;  ctrSuma = 0; promedios = [];
      var sumaMeses = 0; ctrSumaMeses = 0; promediosMesesPorHoras = []; var promediosMeses = [];
      var sumaHoras = 0; ctrHoras = 0; promediosDias = [];
      var promedio = 0; promedioMes = 0;

      var cantidadDiasAlMes = 0;
      var valoresMensualesPorHoras = [];

      function procesarDatos(datosPrueba){
        valores = [];
        fechas = [];
        promediosDias = [];
        dias = [];
        promediosMeses = [];
        meses = [];
        celdas = [];
        celdasMeses = [];
        horas = [];


            //Obtener datos diarios
            for(let i = 0; datosPrueba.length > i; i++){
                fechas.push(datosPrueba[i].marcatiempo);
                valores.push(datosPrueba[i].valor);
                var res = datosPrueba[i].marcatiempo.split(" ");
                //Almacena los diferentes dias
                if(res[0] != dia){
                    dias.push(res[0]);
                    dia = res[0];
                    //Guarda el promedio para cada dia en total
                    if(i!=0){
                        promediosDias.push(sumaHoras/ctrHoras);
                        sumaHoras = 0;
                        ctrHoras = 0;
                    }
                    //Almacena los diferentes meses
                    if(i == 0){
                        meses.push(res[0].substr(0, 7));
                        mes = res[0].substr(0, 7);
                    }else if(res[0].substr(0, 7) != mes){
                        diasPorTodosLosMeses.push(cantidadDiasAlMes);
                        cantidadDiasAlMes = 0;

                        meses.push(res[0].substr(0, 7));
                        mes = res[0].substr(0, 7);
                    }
                    cantidadDiasAlMes ++;
                } 
                //Calcula el promedio por dia
                if(res[0] == dia || i == 0){
                    sumaHoras+=datosPrueba[i].valor;
                    ctrHoras++;
                }
                //Almacena la cantidad de dias que tiene el ultimo mes y guarda el promedio para el ultimo dia en total
                if(i == datosPrueba.length - 1){
                        diasPorTodosLosMeses.push(cantidadDiasAlMes);
                        cantidadDiasAlMes = 0;

                        promediosDias.push(sumaHoras/ctrHoras);
                        sumaHoras = 0;
                        ctrHoras = 0;
                }
                //Almacena las diferentes horas
                if(res[1].substr(0, 2) != hora && res[1].substr(0, 2) > hora){
                    horas.push(res[1].substr(0, 2)+":00");
                    hora = res[1].substr(0, 2);
                }
            }
            //Genera una matriz con los promedios de los valores para cada hora
            let p = 0;
            for(let k = 0;  k < dias.length; k++){
                for(let j = 0; j < horas.length; j++){
                    let arr = [];
                    arr[0] = k;
                    arr[1] = j;
                    arr[2] = valores[p];
                    celdas.push(arr);
                    p ++;
                }
            }
            //Obtiene el promedio para cada mes
            p = 0;
            let aux = 0;
            let aux2 = 0;
            while(p<diasPorTodosLosMeses.length){
                aux2 += diasPorTodosLosMeses[p];
                for(let i = 0; i < horas.length; i++){
                    for(let j = aux; j < aux2; j++){
                        //console.log(i+(horas.length*j));
                        //Recorre cada hora de cada mes
                        if(valores[i+(horas.length*j)] != undefined){
                            promedioMes+=valores[i+(horas.length*j)];
                            ctrSumaMeses++;
                        }
                        //console.log(promedioMes+" - "+ctrSumaMeses);
                    }
                    //almacena el promedio por mes en cada una de sus horas
                    promediosMesesPorHoras.push(promedioMes/ctrSumaMeses);
                    //console.log(promediosMesesPorHoras);
                    promedioMes = 0;
                    ctrSumaMeses = 0;
                }
                aux += diasPorTodosLosMeses[p];
                //console.log("AUX: " + aux);
                //Empieza a recorrer las horas del siguiente mes
                p++;
            }
            //Genera una matriz con los promedios de los valores para cada hora de los meses y el promedio completo para cada mes
            p = 0;
            for(let k = 0;  k < meses.length; k++){
                for(let j = 0; j < horas.length; j++){
                    //genera la matriz con los promedios para cada hora de los meses
                    let arr = [];
                    arr[0] = k;
                    arr[1] = j;
                    arr[2] = promediosMesesPorHoras[p];
                    celdasMeses.push(arr);
                    
                    //Genera el promedio completo para todo el mes
                    sumaMeses++;
                    promedioMes += promediosMesesPorHoras[p];

                    p ++;
                }
                promediosMeses.push(promedioMes/sumaMeses);
                sumaMeses = 0;
                promedioMes = 0;
            }
            //console.log(promediosMeses);
            //console.log(meses);

            //Llama el metodo para pintar las graficas
            cargarGraficaMapaDeCalor(0);
            cargarGraficaAreaSimple(0);
        }

        function cargarGraficaAreaSimple(formato){
            //horas
            data = 0;
            dataX = 0;
            if(formato == 0){
                data = valores;
                dataX = fechas;
            }//dias
            else if(formato == 1){
                data = promediosDias;
                dataX = dias;
            }//meses
            else if(formato == 2){
                data = promediosMeses;
                dataX = meses;
            }
            console.log(data);
            console.log(dataX);

            option = {
                tooltip: {
                    trigger: 'axis',
                    position: function (pt) {
                        return [pt[0], '10%'];
                    }
                },
                title: {
                    left: 'center',
                    text: 'Area Simple',
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: dataX
                },
                yAxis: {
                    type: 'value',
                    boundaryGap: [0, '100%']
                },
                dataZoom: [{
                    type: 'inside',
                    start: 0,
                    end: 100
                }, {
                    start: 0,
                    end: 100,
                    handleIcon: 'M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
                    handleSize: '80%',
                    handleStyle: {
                        color: '#fff',
                        shadowBlur: 3,
                        shadowColor: 'rgba(0, 0, 0, 0.6)',
                        shadowOffsetX: 2,
                        shadowOffsetY: 2
                    }
                }],
                series: [
                    {
                        name:'Valor',
                        type:'line',
                        smooth:true,
                        symbol: 'none',
                        sampling: 'average',
                        itemStyle: {
                            color: 'rgb(255, 70, 131)'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                                offset: 0,
                                color: 'rgb(255, 158, 68)'
                            }, {
                                offset: 1,
                                color: 'rgb(255, 70, 131)'
                            }])
                        },
                        data:data
                    }
                ]
            };
            // use configuration item and data specified to show chart
            myChart.setOption(option);
            window.myChart.resize();
        }

        function cargarGraficaMapaDeCalor(formato){
            if(formato == 0){
                data = celdas;
                dataX = dias;
                dataY = horas;
            }else if(formato == 1){
                data = celdasMeses;
                dataX = meses;
                dataY = horas;
            }
            
            option = {
            tooltip: {
                position: 'top'
            },
            title: {
                        left: 'center',
                        text: 'Mapa de Calor'
                    },
            animation: false,
            grid: {
                height: '75%',
                width: '80%',
                y: '8%',
                x:'8%'
            },
            xAxis: {
                type: 'category',
                data: dataX,
                splitArea: {
                    show: true
                }
            },
            yAxis: {
                type: 'category',
                data: dataY,
                splitArea: {
                    show: true
                }
            },
                dataZoom: [{
                    type: 'inside',
                    start: 0,
                    end: 100
                }, {
                    start: 0,
                    end: 100,
                    left: '8%',
                    bottom: '8%',
                    handleIcon: 'M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
                    handleSize: '80%',
                    handleStyle: {
                        color: '#fff',
                        shadowBlur: 3,
                        shadowColor: 'rgba(0, 0, 0, 0.6)',
                        shadowOffsetX: 2,
                        shadowOffsetY: 2
                    }
                }],
            visualMap: {
                min: 0,
                max: 14,
                calculable: true,
                orient: 'horizontal',
                left: '40%',
                bottom: '0%'
            },
            series: [{
                name: 'Valor',
                type: 'heatmap',
                sampling: 'average',
                label: {
                    normal: {
                        show: false
                    }
                },
                itemStyle: {
                    emphasis: {
                        shadowBlur: 10,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                },
                data: data
            }]
        };
            myChart2.setOption(option);
            window.myChart.resize();
        }

        function traerDatos(fechas){
            var url = "http://11.11.6.11:3000/registros/lapso?inicio=" + fechas;
            fetch(url,{
                method: 'GET',
                headers: {
                    'Access-Control-Allow-Origin':"*",
                    'Access-Control-Allow-Headers':"*",
                    'Content-Type':'Application/JSON',
                    'Accept':'application/json; odata=verbose'
                }
            }) // Call the fetch function passing the url of the API as a parameter
            .then((resp) => resp.json())
            .then(function(data) {
                // Your code for handling the data you get from the API
                console.log(data);
                procesarDatos(data);
            })
            .catch(function(errors) {
                console.log(errors);
                // This is where you run code if the server returns any errors
            });
        }

    </script>
</body>

</html>